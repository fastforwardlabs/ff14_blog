<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Evaluating QA: the Retriever &amp; the Full QA System | NLP for Question Answering</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Evaluating QA: the Retriever &amp; the Full QA System" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A review of Information Retrieval and the role it plays in an IR QA system" />
<meta property="og:description" content="A review of Information Retrieval and the role it plays in an IR QA system" />
<link rel="canonical" href="https://qa.fastforwardlabs.com/elasticsearch/mean%20average%20precision/recall%20for%20irqa/qa%20system%20design/2020/06/30/Evaluating_the_Retriever_&_End_to_End_System.html" />
<meta property="og:url" content="https://qa.fastforwardlabs.com/elasticsearch/mean%20average%20precision/recall%20for%20irqa/qa%20system%20design/2020/06/30/Evaluating_the_Retriever_&_End_to_End_System.html" />
<meta property="og:site_name" content="NLP for Question Answering" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-30T00:00:00-05:00" />
<script type="application/ld+json">
{"dateModified":"2020-06-30T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://qa.fastforwardlabs.com/elasticsearch/mean%20average%20precision/recall%20for%20irqa/qa%20system%20design/2020/06/30/Evaluating_the_Retriever_&_End_to_End_System.html"},"description":"A review of Information Retrieval and the role it plays in an IR QA system","@type":"BlogPosting","url":"https://qa.fastforwardlabs.com/elasticsearch/mean%20average%20precision/recall%20for%20irqa/qa%20system%20design/2020/06/30/Evaluating_the_Retriever_&_End_to_End_System.html","headline":"Evaluating QA: the Retriever &amp; the Full QA System","datePublished":"2020-06-30T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://qa.fastforwardlabs.com/feed.xml" title="NLP for Question Answering" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-157475426-3','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Evaluating QA: the Retriever &amp; the Full QA System | NLP for Question Answering</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Evaluating QA: the Retriever &amp; the Full QA System" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A review of Information Retrieval and the role it plays in an IR QA system" />
<meta property="og:description" content="A review of Information Retrieval and the role it plays in an IR QA system" />
<link rel="canonical" href="https://qa.fastforwardlabs.com/elasticsearch/mean%20average%20precision/recall%20for%20irqa/qa%20system%20design/2020/06/30/Evaluating_the_Retriever_&_End_to_End_System.html" />
<meta property="og:url" content="https://qa.fastforwardlabs.com/elasticsearch/mean%20average%20precision/recall%20for%20irqa/qa%20system%20design/2020/06/30/Evaluating_the_Retriever_&_End_to_End_System.html" />
<meta property="og:site_name" content="NLP for Question Answering" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-30T00:00:00-05:00" />
<script type="application/ld+json">
{"dateModified":"2020-06-30T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://qa.fastforwardlabs.com/elasticsearch/mean%20average%20precision/recall%20for%20irqa/qa%20system%20design/2020/06/30/Evaluating_the_Retriever_&_End_to_End_System.html"},"description":"A review of Information Retrieval and the role it plays in an IR QA system","@type":"BlogPosting","url":"https://qa.fastforwardlabs.com/elasticsearch/mean%20average%20precision/recall%20for%20irqa/qa%20system%20design/2020/06/30/Evaluating_the_Retriever_&_End_to_End_System.html","headline":"Evaluating QA: the Retriever &amp; the Full QA System","datePublished":"2020-06-30T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://qa.fastforwardlabs.com/feed.xml" title="NLP for Question Answering" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-157475426-3','auto');ga('require','displayfeatures');ga('send','pageview');</script>



<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">NLP for Question Answering</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Us</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Evaluating QA: the Retriever &amp; the Full QA System</h1><p class="page-description">A review of Information Retrieval and the role it plays in an IR QA system</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-06-30T00:00:00-05:00" itemprop="datePublished">
        Jun 30, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      30 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#elasticsearch">elasticsearch</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#mean average precision">mean average precision</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#recall for IRQA">recall for IRQA</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#QA system design">QA system design</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/fastforwardlabs/ff14_blog/tree/master/_notebooks/2020-06-30-Evaluating_the_Retriever_&_End_to_End_System.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/fastforwardlabs/ff14_blog/master?filepath=_notebooks%2F2020-06-30-Evaluating_the_Retriever_%26_End_to_End_System.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/fastforwardlabs/ff14_blog/blob/master/_notebooks/2020-06-30-Evaluating_the_Retriever_&_End_to_End_System.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h3"><a href="#Prerequisites">Prerequisites </a></li>
<li class="toc-entry toc-h1"><a href="#Retrieving-the-right-document-is-important">Retrieving the right document is important </a></li>
<li class="toc-entry toc-h1"><a href="#Elasticsearch-as-an-IR-Tool">Elasticsearch as an IR Tool </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Using-Elasticsearch-with-SQuAD2.0">Using Elasticsearch with SQuAD2.0 </a></li>
<li class="toc-entry toc-h2"><a href="#Evaluating-Retriever-Performance">Evaluating Retriever Performance </a></li>
<li class="toc-entry toc-h2"><a href="#Improving-Search-Results-with-a-Custom-Analyzer">Improving Search Results with a Custom Analyzer </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#The-Full-IR-QA-System">The Full IR QA System </a>
<ul>
<li class="toc-entry toc-h2"><a href="#Connecting-the-retriever-to-the-reader">Connecting the retriever to the reader </a></li>
<li class="toc-entry toc-h2"><a href="#Evaluating-the-system">Evaluating the system </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Final-Thoughts">Final Thoughts </a></li>
<li class="toc-entry toc-h1"><a href="#Post-Script:-The-Code">Post Script: The Code </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-06-30-Evaluating_the_Retriever_&_End_to_End_System.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In our last post, <a href="https://qa.fastforwardlabs.com/no%20answer/null%20threshold/bert/distilbert/exact%20match/f1/robust%20predictions/2020/06/09/Evaluating_BERT_on_SQuAD.html">Evaluating QA: Metrics, Predictions, and the Null Response</a>, we took a deep dive into how to assess the quality of a BERT-like Reader for Question Answering (QA) using the Hugging Face framework. In this post, we'll focus on the other component of a modern Information Retrieval-based (IR) QA system: the Retriever. Specifically, we'll introduce Elasticsearch as a powerful and efficient IR tool that can be used to scour through large corpora and retrieve relevant documents. We'll explain how to implement and evaluate a Retriever in the context of Question Answering and demonstrate its impact on an IR QA system.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Prerequisites">
<a class="anchor" href="#Prerequisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisites<a class="anchor-link" href="#Prerequisites"> </a>
</h3>
<ul>
<li>a basic understanding of Information Retrieval &amp; Search</li>
<li>a basic understanding of IR based QA systems (see our <a href="https://qa.fastforwardlabs.com/">previous posts</a>)</li>
<li>a basic understanding of Transformers and PyTorch</li>
<li>a basic understanding of the SQuAD2.0 dataset</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Retrieving-the-right-document-is-important">
<a class="anchor" href="#Retrieving-the-right-document-is-important" aria-hidden="true"><span class="octicon octicon-link"></span></a>Retrieving the right document is important<a class="anchor-link" href="#Retrieving-the-right-document-is-important"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As we've discussed throughout this series, many modern QA systems take a two-staged approach to answering questions. In the first stage, a document retriever selects <em>N</em> potentially relevant documents from a given corpus. Subsequently, a machine comprehension model processes each of the <em>N</em> documents to determine an answer to the input question.</p>
<p>Because of recent advances in NLP and deep learning (i.e., flashy Transformers), the machine comprehension component has typically been the main focus of evaluation and performance enhancement. Retrievers have received limited attention in the context of QA, despite their obvious importance: stage two of an IR QA system is bounded by the performance of stage one. Let's get more specific.</p>
<p>We <a href="https://qa.fastforwardlabs.com/no%20answer/null%20threshold/bert/distilbert/exact%20match/f1/robust%20predictions/2020/06/09/Evaluating_BERT_on_SQuAD.html">recently explained methods</a> that - given a question and context passage - enable BERT-like models to produce robust answers by selectively processing predictions and by refraining from answering certain questions at all. While the ability to properly comprehend a passage and produce a correct answer is a critical feature of any QA tool, the success of the overall system is highly dependent on first providing a correct passage to read through. Without being fed a context passage that actually contains the ground-truth answer, the overall system's performance is limited to how well it can predict no-answer questions.</p>
<p>To demonstrate, we'll revisit an example from our <a href="https://qa.fastforwardlabs.com/pytorch/hugging%20face/wikipedia/bert/transformers/2020/05/19/Getting_Started_with_QA.html">second blog post</a>, in which we asked three questions of a Wikipedia search engine-based QA system:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>**Example 1: Incorrect**
Question: When was Barack Obama born?
Top wiki result: &lt;WikipediaPage 'Barack Obama Sr.'&gt;
Answer: 18 June 1936 / February 2 , 1961 / 

**Example 2: Correct**
Question: Why is the sky blue?
Top wiki result: &lt;WikipediaPage 'Diffuse sky radiation'&gt;
Answer: Rayleigh scattering / 

**Example 3: Correct**
Question: How many sides does a pentagon have?
Top wiki result: &lt;WikipediaPage 'The Pentagon'&gt;
Answer: five /</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In Example 1, the Reader had no chance of producing the correct answer because of its outright absence from the context served up by the Retriever. Namely, the Retriever erroneously provided a page about Barack Obama Sr. instead of his son, the former US President. In this case, the only way the Reader could have possibly produced the correct answer was if the correct answer was actually not to answer at all.</p>
<p>On the flip side, in Example 3, the Retriever did not identify the globally "correct" document - it returned an article about "The Pentagon" instead of a page about geometry - but nonetheless, it provided enough context for the Reader to succeed.</p>
<p>These quick examples illustrate why an effective Retriever is crucial for an end-to-end QA system. Now let's take a deeper look at a classic tool used for information retrieval - Elasticsearch.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Elasticsearch-as-an-IR-Tool">
<a class="anchor" href="#Elasticsearch-as-an-IR-Tool" aria-hidden="true"><span class="octicon octicon-link"></span></a>Elasticsearch as an IR Tool<a class="anchor-link" href="#Elasticsearch-as-an-IR-Tool"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://github.com/fastforwardlabs/ff14_blog/blob/master/_notebooks/my_icons/elasticsearch-logo.png?raw=1" alt=""></p>
<p>Modern QA systems employ a variety of techniques for the task of information retrieval, ranging from traditional sparse vector word matching (e.g., Elasticsearch) to <a href="https://arxiv.org/pdf/2004.04906.pdf">novel approaches</a> using dense representations of encoded passages combined with <a href="https://github.com/facebookresearch/faiss">efficient search capabilities</a>. Despite the flurry of contemporary research efforts in this area, the traditional sparse vector approach performs very well overall, and has only recently been overtaken by embedding-based systems for QA retrieval tasks. For that reason, we'll explore Elasticsearch as an easy-to-use framework for document retrieval. So, what exactly is Elasticsearch?</p>
<p>Elasticsearch is a powerful open-source search and analytics engine built on the <a href="https://lucene.apache.org/">Apache Lucene</a> library that is capable of handling all types of data - including textual, numerical, geospatial, structured, and unstructured data. It is built to scale with a robust set of features, rich ecosystem, and diverse list of client libraries, making it easy to integrate and use. In the context of information retrieval for automated question answering, we are keenly interested in the features surrounding full-text search.</p>
<p>Elasticsearch provides a convenient way to index documents so they can quickly be queried for nearest neighbor search using a similarity metric based on TF-IDF. Specifically, it uses <a href="https://opensourceconnections.com/blog/2015/10/16/bm25-the-next-generation-of-lucene-relevation/">BM25</a> term weighting to represent question and context passages as high-dimensional, sparse vectors that are efficiently searched in an inverted index. For more information on how an inverted index works under the hood, we recommend this quick and concise <a href="https://codingexplained.com/coding/elasticsearch/understanding-the-inverted-index-in-elasticsearch">blog post</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Using-Elasticsearch-with-SQuAD2.0">
<a class="anchor" href="#Using-Elasticsearch-with-SQuAD2.0" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Elasticsearch with SQuAD2.0<a class="anchor-link" href="#Using-Elasticsearch-with-SQuAD2.0"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With this basic understanding of how Elasticsearch works, let's dive in and build our own Document Retrieval system by indexing a set of Wikipedia article paragraphs that support questions and answers from the SQuAD2.0 dataset. Before we get started, we'll need to download and prepare data from SQuAD2.0.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Download and Prepare SQUAD2.0</strong></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-hide</span>

<span class="c1"># Download the SQuAD2.0 train &amp; dev sets</span>
<span class="o">!</span>wget -P data/squad/ https://rajpurkar.github.io/SQuAD-explorer/dataset/train-v2.0.json
<span class="o">!</span>wget -P data/squad/ https://rajpurkar.github.io/SQuAD-explorer/dataset/dev-v2.0.json
    
<span class="kn">import</span> <span class="nn">json</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A common practice in IR for QA is to segment large articles into smaller passages before indexing, for two main reasons:</p>
<ol>
<li>Transformer-based Readers are slow; providing an entire Wikipedia article to BERT for processing can take 5 - 30 seconds, even with a decent GPU!</li>
<li>Smaller passages reduce noise; by identifying a more concise context passage for BERT to read through, we reduce the chance of BERT getting lost.</li>
</ol>
<p>Of course, the chunking method proposed here doesn't come without a cost. Larger documents contain more information on which to retrieve. By reducing passage size, we are potentially trading off system recall for speed - although, as we will discuss later in this post, there are techniques to alleviate this.</p>
<p>With our chunking approach, each article paragraph will be prepended with the article title, and collectively serve as the corpus of documents over which our Elasticsearch Retriever will search. In practice, open-domain QA systems sit atop massive collections of documents (think: all of Wikipedia) to provide a breadth of information from which to answer general-knowledge questions. For the purposes of demonstrating Elasticsearch functionality, we will limit our corpus to only the Wikipedia articles supporting SQuAD2.0 questions.</p>
<p>The following <code>parse_qa_records</code> function will extract question/answer examples, as well as paragraph content from the SQuAD2.0 data set.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-hide</span>

<span class="k">def</span> <span class="nf">parse_qa_records</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Loop through SQuAD2.0 dataset and parse out question/answer examples and unique article paragraphs</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        qa_records (list) - Question/answer examples as list of dictionaries</span>
<span class="sd">        wiki_articles (list) - Unique Wikipedia titles and article paragraphs recreated from SQuAD data</span>
<span class="sd">    </span>
<span class="sd">    '''</span>
    <span class="n">num_with_ans</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_without_ans</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">qa_records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">wiki_articles</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">article</span><span class="p">[</span><span class="s1">'paragraphs'</span><span class="p">]):</span>
            
            <span class="n">wiki_articles</span><span class="p">[</span><span class="n">article</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span><span class="o">+</span><span class="sa">f</span><span class="s1">'_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="n">paragraph</span><span class="p">[</span><span class="s1">'context'</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">questions</span> <span class="ow">in</span> <span class="n">paragraph</span><span class="p">[</span><span class="s1">'qas'</span><span class="p">]:</span>
                
                <span class="n">qa_record</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">qa_record</span><span class="p">[</span><span class="s1">'example_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">questions</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
                <span class="n">qa_record</span><span class="p">[</span><span class="s1">'document_title'</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
                <span class="n">qa_record</span><span class="p">[</span><span class="s1">'question_text'</span><span class="p">]</span> <span class="o">=</span> <span class="n">questions</span><span class="p">[</span><span class="s1">'question'</span><span class="p">]</span>
                
                <span class="k">try</span><span class="p">:</span> 
                    <span class="n">qa_record</span><span class="p">[</span><span class="s1">'short_answer'</span><span class="p">]</span> <span class="o">=</span> <span class="n">questions</span><span class="p">[</span><span class="s1">'answers'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'text'</span><span class="p">]</span>
                    <span class="n">num_with_ans</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">qa_record</span><span class="p">[</span><span class="s1">'short_answer'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">""</span>
                    <span class="n">num_without_ans</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                <span class="n">qa_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qa_record</span><span class="p">)</span>
        
        
    <span class="n">wiki_articles</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">'document_title'</span><span class="p">:</span><span class="n">title</span><span class="p">,</span> <span class="s1">'document_text'</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>\
                         <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">wiki_articles</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Data contains </span><span class="si">{</span><span class="n">num_with_ans</span><span class="si">}</span><span class="s1"> question/answer pairs with a short answer, and </span><span class="si">{</span><span class="n">num_without_ans</span><span class="si">}</span><span class="s1"> without.'</span><span class="o">+</span>
          <span class="sa">f</span><span class="s1">'</span><span class="se">\n</span><span class="s1">There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">wiki_articles</span><span class="p">)</span><span class="si">}</span><span class="s1"> unique wikipedia article paragraphs.'</span><span class="p">)</span>
                
    <span class="k">return</span> <span class="n">qa_records</span><span class="p">,</span> <span class="n">wiki_articles</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># load and parse data</span>
<span class="n">train_file</span> <span class="o">=</span> <span class="s2">"data/squad/train-v2.0.json"</span>
<span class="n">dev_file</span> <span class="o">=</span> <span class="s2">"data/squad/dev-v2.0.json"</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">train_file</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">))</span>
<span class="n">dev</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">dev_file</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">))</span>

<span class="n">qa_records</span><span class="p">,</span> <span class="n">wiki_articles</span> <span class="o">=</span> <span class="n">parse_qa_records</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s1">'data'</span><span class="p">])</span>
<span class="n">qa_records_dev</span><span class="p">,</span> <span class="n">wiki_articles_dev</span> <span class="o">=</span> <span class="n">parse_qa_records</span><span class="p">(</span><span class="n">dev</span><span class="p">[</span><span class="s1">'data'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Data contains 86821 question/answer pairs with a short answer, and 43498 without.
There are 19035 unique wikipedia article paragraphs.
Data contains 5928 question/answer pairs with a short answer, and 5945 without.
There are 1204 unique wikipedia article paragraphs.
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># parsed record example</span>
<span class="n">qa_records</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'example_id': '56d43c5f2ccc5a1400d830ab',
 'document_title': 'Beyoncé',
 'question_text': 'What was the first album Beyoncé released as a solo artist?',
 'short_answer': 'Dangerously in Love'}</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># parsed wiki paragraph example</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wiki_articles</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{'document_title': 'Beyoncé_10', 'document_text': 'Beyoncé Beyoncé\'s first solo recording was a feature on Jay Z\'s "\'03 Bonnie &amp; Clyde" that was released in October 2002, peaking at number four on the U.S. Billboard Hot 100 chart. Her first solo album Dangerously in Love was released on June 24, 2003, after Michelle Williams and Kelly Rowland had released their solo efforts. The album sold 317,000 copies in its first week, debuted atop the Billboard 200, and has since sold 11 million copies worldwide. The album\'s lead single, "Crazy in Love", featuring Jay Z, became Beyoncé\'s first number-one single as a solo artist in the US. The single "Baby Boy" also reached number one, and singles, "Me, Myself and I" and "Naughty Girl", both reached the top-five. The album earned Beyoncé a then record-tying five awards at the 46th Annual Grammy Awards; Best Contemporary R&amp;B Album, Best Female R&amp;B Vocal Performance for "Dangerously in Love 2", Best R&amp;B Song and Best Rap/Sung Collaboration for "Crazy in Love", and Best R&amp;B Performance by a Duo or Group with Vocals for "The Closer I Get to You" with Luther Vandross.'}
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Download Elasticsearch</strong></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With our data ready to go, let's download, install, and configure Elasticsearch. We recommend opening this post as a Colab notebook and executing the following code snippet to set up Elasticsearch. Alternatively, you can install and launch Elasticsearch on your local machine by following the instructions <a href="https://www.elastic.co/downloads/elasticsearch">here</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-hide</span>

<span class="c1"># if using Colab - start Elasticsearch from source</span>
<span class="o">!</span> wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.6.2-linux-x86_64.tar.gz -q
<span class="o">!</span> tar -xzf elasticsearch-7.6.2-linux-x86_64.tar.gz
<span class="o">!</span> chown -R daemon:daemon elasticsearch-7.6.2

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span><span class="p">,</span> <span class="n">STDOUT</span>
<span class="n">es_server</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s1">'elasticsearch-7.6.2/bin/elasticsearch'</span><span class="p">],</span>
                   <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">,</span>
                   <span class="n">preexec_fn</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># as daemon</span>
                  <span class="p">)</span>
<span class="c1"># wait until ES has started</span>
<span class="o">!</span> sleep <span class="m">30</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Load Data into Elasticsearch</strong></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll use the <a href="https://elasticsearch-py.readthedocs.io/en/master/">official low-level Python client library</a> for interacting with Elasticsearch.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-hide</span>
<span class="o">!</span>pip install elasticsearch
<span class="o">!</span>pip install tqdm
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>By default, Elasticsearch is launched locally on port 9200. We first need to instantiate an Elasticsearch client object and connect to the service.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'host'</span><span class="p">:</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'port'</span><span class="p">:</span><span class="mi">9200</span><span class="p">}</span>
<span class="n">es</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">([</span><span class="n">config</span><span class="p">])</span>

<span class="c1"># test connection</span>
<span class="n">es</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Before we go further, let's introduce a few concepts that are specific to Elasticsearch and the process of indexing data. An <em>index</em> is a collection of documents that have common characteristics (similar to a database schema in an RDBMS). <em>Documents</em> are JSON objects having their own set of key-value pairs consisting of various data types (similar to rows/fields in RDBMS).</p>
<p>When we add a document into an index, the document's text fields undergo analysis prior to being indexed. This means that when executing a search query against an index, we are actually searching against the post-processed representation that is stored in the inverted index, not the raw input document itself.</p>
<p><img src="https://github.com/fastforwardlabs/ff14_blog/blob/master/_notebooks/my_icons/elastic_index_process.png?raw=1" alt="Elasticsearch Index Process">
<a href="https://codingexplained.com/coding/elasticsearch/understanding-analysis-in-elasticsearch-analyzers#:~:text=A%20Closer%20Look%20at%20Analyzers,documents%20when%20they%20are%20indexed.&amp;text=An%20analyzer%20consists%20of%20three,them%20changing%20the%20input%20stream.">Image Credit</a></p>
<p>The analysis process is a customizable pipeline carried out by an <em>Analyzer</em>. Elasticsearch analyzer pipelines are composed of three sequential steps: <em>character filters</em>, a <em>tokenizer</em>, and <em>token filters.</em> Each of these components modifies the input stream of text according to some configurable settings.</p>
<ul>
<li>
<strong>Character filters</strong> have the ability to add, remove, or replace characters. A common application is to strip <code>html</code> markup from the raw input. </li>
<li>The character-filtered text is passed to a <strong>tokenizer</strong> which breaks up the input string into individual tokens. The default (<code>standard</code>) tokenizer splits tokens on whitespace, and most symbols (like commas, periods, semicolons, etc.)</li>
<li>The token stream is passed to a <strong>token filter</strong> which adds, removes, or modifies tokens. Typical token filters include converting all text to <code>lowercase</code>, and removing <code>stop</code> words. </li>
</ul>
<p>Elasticsearch comes with several built-in Analyzers that satisfy common use cases and defaults to the <code>Standard Analyzer</code>. The Standard Analyzer doesn't contain any character filters, uses a <code>standard</code> tokenizer, and applies a <code>lowercase</code> token filter. Let's take a look at an example sentence as it's passed through this pipeline:</p>
<blockquote>
<p>"I'm in the mood for drinking semi-dry red wine!"</p>
</blockquote>
<p><img src="https://github.com/fastforwardlabs/ff14_blog/blob/master/_notebooks/my_icons/elasticsearch_standard_analyzer.png?raw=1" alt="Elasticsearch Analyzer Pipeline"><a href="https://codingexplained.com/coding/elasticsearch/understanding-analysis-in-elasticsearch-analyzers#:~:text=A%20Closer%20Look%20at%20Analyzers,documents%20when%20they%20are%20indexed.&amp;text=An%20analyzer%20consists%20of%20three,them%20changing%20the%20input%20stream.">Image Credit</a></p>
<p>Crafting analyzers to your use case requires domain knowledge of the problem and dataset at hand, and doing so properly is key to optimizing relevance scoring for your search application. We found <a href="https://medium.com/elasticsearch/contents-cebdc419c8c9">this blog series</a> very useful in explaining the importance of analysis in Elasticsearch.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong><em>Create an Index</em></strong></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's create a new index and add our Wikipedia articles to it. To do so, we provide a name and optionally some index configurations. Here we are specifying a set of <code>mappings</code> that indicate our anticipated index schema, data types, and how the text fields should be processed. If no <code>body</code> is passed, Elasticsearch will automatically infer fields and data types from incoming documents, as well as apply the <code>Standard Analyzer</code> to any text fields.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">index_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"settings"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"analysis"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"analyzer"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"standard_analyzer"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"standard"</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">"mappings"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"dynamic"</span><span class="p">:</span> <span class="s2">"strict"</span><span class="p">,</span> 
        <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"document_title"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"text"</span><span class="p">,</span> <span class="s2">"analyzer"</span><span class="p">:</span> <span class="s2">"standard_analyzer"</span><span class="p">},</span>
            <span class="s2">"document_text"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"text"</span><span class="p">,</span> <span class="s2">"analyzer"</span><span class="p">:</span> <span class="s2">"standard_analyzer"</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="n">index_name</span> <span class="o">=</span> <span class="s1">'squad-standard-index'</span>
<span class="n">es</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">index_config</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'acknowledged': True,
 'index': 'squad-standard-index',
 'shards_acknowledged': True}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong><em>Populate the Index</em></strong></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can then loop through our list of Wikipedia titles and articles and add them to our newly created Elasticsearch index.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-hide</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="k">def</span> <span class="nf">populate_index</span><span class="p">(</span><span class="n">es_obj</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">evidence_corpus</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Loads records into an existing Elasticsearch index</span>

<span class="sd">    Args:</span>
<span class="sd">        es_obj (elasticsearch.client.Elasticsearch) - Elasticsearch client object</span>
<span class="sd">        index_name (str) - Name of index</span>
<span class="sd">        evidence_corpus (list) - List of dicts containing data records</span>

<span class="sd">    '''</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">evidence_corpus</span><span class="p">)):</span>
    
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index_status</span> <span class="o">=</span> <span class="n">es_obj</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">rec</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Unable to load document </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.'</span><span class="p">)</span>
            
    <span class="n">n_records</span> <span class="o">=</span> <span class="n">es_obj</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index_name</span><span class="p">)[</span><span class="s1">'count'</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Succesfully loaded </span><span class="si">{</span><span class="n">n_records</span><span class="si">}</span><span class="s1"> into </span><span class="si">{</span><span class="n">index_name</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>


    <span class="k">return</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">all_wiki_articles</span> <span class="o">=</span> <span class="n">wiki_articles</span> <span class="o">+</span> <span class="n">wiki_articles_dev</span>

<span class="n">populate_index</span><span class="p">(</span><span class="n">es_obj</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">'squad-standard-index'</span><span class="p">,</span> <span class="n">evidence_corpus</span><span class="o">=</span><span class="n">all_wiki_articles</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
Succesfully loaded 20239 into squad-standard-index
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong><em>Search the Index</em></strong></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Wahoo! We now have some documents loaded into an index. Elasticsearch provides a rich <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html">query language</a> that supports a diverse range of query types. For this example, we'll use the standard query for performing full text search called a <code>match</code> query. By default, Elasticsearch sorts and returns a JSON response of search results based on a computed <a href="https://qbox.io/blog/practical-guide-elasticsearch-scoring-relevancy#:~:text=Together%2C%20these%20combine%20into%20a,number%20known%20as%20the%20_score.">relevance score</a>, which indicates how well a given document matches the query. In addition, the search response also includes the amount of time the query took to run.</p>
<p>Let's look at a simple <code>match</code> query used to search the <code>document_text</code> field in our newly created index.
</p>
<div class="flash flash-warn">
    <svg class="octicon octicon-zap" viewbox="0 0 10 16" version="1.1" width="10" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M10 7H6l3-7-9 9h4l-3 7 9-9z"></path></svg>
    <strong>Important: </strong>As previously mentioned, all documents in the index have gone through an analysis process prior to indexing; this is called <em>index time analysis.</em> To maintain consistency in matching text queries against the post-processed index tokens, the same Analyzer used on a given field at index time is automatically applied to the query text at search time. <em>Search time analysis</em> is applied depending on which query type is used; <code>match</code> queries apply search time analysis by default.
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-hide</span>
<span class="k">def</span> <span class="nf">search_es</span><span class="p">(</span><span class="n">es_obj</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">question_text</span><span class="p">,</span> <span class="n">n_results</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Execute an Elasticsearch query on a specified index</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        es_obj (elasticsearch.client.Elasticsearch) - Elasticsearch client object</span>
<span class="sd">        index_name (str) - Name of index to query</span>
<span class="sd">        query (dict) - Query DSL</span>
<span class="sd">        n_results (int) - Number of results to return</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">        res - Elasticsearch response object</span>
<span class="sd">    </span>
<span class="sd">    '''</span>
    
    <span class="c1"># construct query</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'query'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">'match'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">'document_text'</span><span class="p">:</span> <span class="n">question_text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="n">es_obj</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_results</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">res</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">question_text</span> <span class="o">=</span> <span class="s1">'Who was the first president of the Republic of China?'</span>

<span class="c1"># execute query</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">search_es</span><span class="p">(</span><span class="n">es_obj</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">'squad-standard-index'</span><span class="p">,</span> <span class="n">question_text</span><span class="o">=</span><span class="n">question_text</span><span class="p">,</span> <span class="n">n_results</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Question: </span><span class="si">{</span><span class="n">question_text</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Query Duration: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s2">"took"</span><span class="p">]</span><span class="si">}</span><span class="s1"> milliseconds'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Title, Relevance Score:'</span><span class="p">)</span>
<span class="p">[(</span><span class="n">hit</span><span class="p">[</span><span class="s1">'_source'</span><span class="p">][</span><span class="s1">'document_title'</span><span class="p">],</span> <span class="n">hit</span><span class="p">[</span><span class="s1">'_score'</span><span class="p">])</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">'hits'</span><span class="p">][</span><span class="s1">'hits'</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Question: Who was the first president of the Republic of China?
Query Duration: 74 milliseconds
Title, Relevance Score:
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[('Modern_history_54', 23.131157),
 ('Nanjing_18', 17.076923),
 ('Republic_of_the_Congo_10', 16.840765),
 ('Prime_minister_16', 16.137493),
 ('Korean_War_29', 15.801523),
 ('Korean_War_43', 15.586578),
 ('Qing_dynasty_52', 15.291815),
 ('Chinese_characters_55', 14.773873),
 ('Korean_War_23', 14.736045),
 ('2008_Sichuan_earthquake_48', 14.417962)]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Evaluating-Retriever-Performance">
<a class="anchor" href="#Evaluating-Retriever-Performance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Evaluating Retriever Performance<a class="anchor-link" href="#Evaluating-Retriever-Performance"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok, we now have a basic understanding of how to use Elasticsearch as an IR tool to return some results for a given question, but how do we know if it's working? How do we evaluate what a good IR tool looks like?</p>
<p>We'll need two things to evaluate our Retriever: some labeled examples (i.e., SQuAD2.0 question/answer pairs) and some performance metrics. In the conventional world of information retrieval, there are <a href="https://en.wikipedia.org/wiki/Evaluation_measures_(information_retrieval">many metrics</a>)used to quantify the relevance of query results, largely centered around the concepts of precision and recall. For IR in the context of QA, these ideas are adapted into two commonly used evaluation metrics: <em>recall</em> and <em>mean average precision (mAP)</em>. Additionally, we consider the amount of time required to execute a query, since the main point of having a two-stage QA system is to efficiently narrow the large search space for our Reader.</p>
<p><strong>Recall</strong></p>
<p>Traditionally, <em>recall</em> in IR indicates the fraction of all relevant documents that are retrieved. In this case, we are less concerned with finding <em>all</em> of the passages containing the answer and more concerned with the binary presence of a passage containing the correct answer being returned. In that light, a Retriever's recall is defined across a set of questions as <em>the percentage of questions for which the answer segment appears in one of the top N pages returned by the search method.</em></p>
<p><strong>Mean Average Precision</strong></p>
<p>While the <em>recall</em> metric focuses on the minimum viable result set to enable a Reader for success, we do still care about the composition of that result set. We want a metric that rewards a Retriever for: a) returning a lot of answer-containing documents in the result set (i.e., the traditional meaning of precision), and b) returning those answer-containing documents higher up in the result set than non-answer-containing documents (i.e., ranking them correctly). This is precisely (🙃) what <em>mean average precision</em> (mAP) does for us.</p>
<p>To explain mAP further, let's first break down the concept of average precision for information retrieval. If our Retriever is asked to return <em>N</em> documents and <em>m</em> of those documents contains the true answer, then average precision (AP) is defined as:</p>
<p><img src="https://github.com/fastforwardlabs/ff14_blog/blob/master/_notebooks/my_icons/map_equation.png?raw=1" alt=""></p>
<p>where <em>rel(k)</em> is just a binary indication of whether the kth passage contains the correct answer or not. Using a concrete example, consider retrieving <em>N</em>=3 documents, of which only one contains the correct answer. Here are three scenarios for how this could happen:</p>
<p><img src="https://github.com/fastforwardlabs/ff14_blog/blob/master/_notebooks/my_icons/map_example.png?raw=1" alt=""></p>
<p>Scenario A is rewarded with the highest score because it was able to correctly rank the ground truth document relative to the others returned. Since average precision is calculated on a per-query basis, the mean average precision is simply just <em>the average AP across all queries</em>.</p>
<p>Now, using our Wikipedia passage index, let's define a function called <code>evaluate_retriever</code> to loop through all question/answer examples from the SQuAD2.0 train set and see how well our Elasticsearch Retriever performs in terms of recall, mAP, and average query duration when retrieving <em>N=3</em> passages.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># collapse-hide</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">average_precision</span><span class="p">(</span><span class="n">binary_results</span><span class="p">):</span>
    
    <span class="sd">''' Calculates the average precision for a list of binary indicators '''</span>
    
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">precs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">binary_results</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">precs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">binary_results</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            
    <span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">precs</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
            
    <span class="k">return</span> <span class="n">ap</span>


<span class="k">def</span> <span class="nf">evaluate_retriever</span><span class="p">(</span><span class="n">es_obj</span><span class="p">,</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">qa_records</span><span class="p">,</span> <span class="n">n_results</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    This function loops through a set of question/answer examples from SQuAD2.0 and </span>
<span class="sd">    evaluates Elasticsearch as a information retrieval tool in terms of recall, mAP, and query duration.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        es_obj (elasticsearch.client.Elasticsearch) - Elasticsearch client object</span>
<span class="sd">        index_name (str) - name of index to query</span>
<span class="sd">        qa_records (list) - list of qa_records from preprocessing steps</span>
<span class="sd">        n_results (int) - the number of results ElasticSearch should return for a given query</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        test_results_df (pd.DataFrame) - a dataframe recording search results info for every example in qa_records</span>
<span class="sd">    </span>
<span class="sd">    '''</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">qa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">qa_records</span><span class="p">)):</span>
        
        <span class="n">ex_id</span> <span class="o">=</span> <span class="n">qa</span><span class="p">[</span><span class="s1">'example_id'</span><span class="p">]</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">qa</span><span class="p">[</span><span class="s1">'question_text'</span><span class="p">]</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">qa</span><span class="p">[</span><span class="s1">'short_answer'</span><span class="p">]</span>
        
        <span class="c1"># execute query</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">search_es</span><span class="p">(</span><span class="n">es_obj</span><span class="o">=</span><span class="n">es_obj</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">question_text</span><span class="o">=</span><span class="n">question</span><span class="p">,</span> <span class="n">n_results</span><span class="o">=</span><span class="n">n_results</span><span class="p">)</span>
        
        <span class="c1"># calculate performance metrics from query response info</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">'took'</span><span class="p">]</span>
        <span class="n">binary_results</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">[</span><span class="s1">'_source'</span><span class="p">][</span><span class="s1">'document_text'</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">'hits'</span><span class="p">][</span><span class="s1">'hits'</span><span class="p">]]</span>
        <span class="n">ans_in_res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">binary_results</span><span class="p">))</span>
        <span class="n">ap</span> <span class="o">=</span> <span class="n">average_precision</span><span class="p">(</span><span class="n">binary_results</span><span class="p">)</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="p">(</span><span class="n">ex_id</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">answer</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">ans_in_res</span><span class="p">,</span> <span class="n">ap</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
    
    <span class="c1"># format results dataframe</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'example_id'</span><span class="p">,</span> <span class="s1">'question'</span><span class="p">,</span> <span class="s1">'answer'</span><span class="p">,</span> <span class="s1">'query_duration'</span><span class="p">,</span> <span class="s1">'answer_present'</span><span class="p">,</span> <span class="s1">'average_precision'</span><span class="p">]</span>
    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
    
    <span class="c1"># format results dict</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'Recall'</span><span class="p">:</span> <span class="n">results_df</span><span class="o">.</span><span class="n">answer_present</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
               <span class="s1">'Mean Average Precision'</span><span class="p">:</span> <span class="n">results_df</span><span class="o">.</span><span class="n">average_precision</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
               <span class="s1">'Average Query Duration'</span><span class="p">:</span><span class="n">results_df</span><span class="o">.</span><span class="n">query_duration</span><span class="o">.</span><span class="n">mean</span><span class="p">()}</span>
    
    <span class="k">return</span> <span class="n">results_df</span><span class="p">,</span> <span class="n">metrics</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># combine train/dev examples and filter out SQuAD records that</span>
<span class="c1"># do not have a short answer for the given question</span>
<span class="n">all_qa_records</span> <span class="o">=</span> <span class="n">qa_records</span><span class="o">+</span><span class="n">qa_records_dev</span>
<span class="n">qa_records_answerable</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">all_qa_records</span> <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">'short_answer'</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">]</span>

<span class="c1"># run evaluation</span>
<span class="n">results_df</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">evaluate_retriever</span><span class="p">(</span><span class="n">es_obj</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">'squad-standard-index'</span><span class="p">,</span> <span class="n">qa_records</span><span class="o">=</span><span class="n">qa_records_answerable</span><span class="p">,</span> <span class="n">n_results</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metrics</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'Recall': 0.8226180336176131,
 'Mean Average Precision': 0.7524133234140888,
 'Average Query Duration': 3.0550841518506937}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Improving-Search-Results-with-a-Custom-Analyzer">
<a class="anchor" href="#Improving-Search-Results-with-a-Custom-Analyzer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Improving Search Results with a Custom Analyzer<a class="anchor-link" href="#Improving-Search-Results-with-a-Custom-Analyzer"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Identifying a correct passage in the Top 3 results for 82% of the SQuAD questions in ~3 milliseconds per question is not too bad! But that means that we've effectively limited our overall QA system to an 82% upper bound on performance. How can we improve upon this?</p>
<p>One simple and obvious way to increase recall would be to just retrieve more passages. The following figure shows the effects of varying corpus size and result size on Elasticsearch retriever recall. As expected we see that the number of passages retrieved (i.e. <em>Top N</em>) has a dramatic impact on recall; a ~10-15 point jump from 1 to 3 passages returned, and ~5 point jump for each of the other tiers. We also see a gradual decrease in recall as corpus size increases, which isn't surprising.</p>
<p><img src="https://github.com/fastforwardlabs/ff14_blog/blob/master/_notebooks/my_icons/recall_v_corpussize.png?raw=1" alt="Recall vs. Corpus Size" title="Experimental results demonstrating the impact of increasing corpus size and number of results retrieved on Elasticsearch recall."></p>
<p>While increasing the number of passages retrieved is effective, it also has implications on overall system performance as the (already slow) Reader now has to reason over more text. Instead, we can lean on best practices in the well-explored domain of information retrieval.</p>
<p>Optimizing full text search is a battle between precision (returning as few irrelevant documents as possible) and recall (returning as many relevant documents as possible). Matching only exact words in the question results in high precision; however, it misses out on many passages that could be relevant. We can cast a wider net by searching for terms that are not <em>exactly</em> the same as those in the question, but are related in some way. Here, Elasticsearch Analyzers can help. Earlier in this post, we described how Analyzers provide a flexible and extensible method to tailor search for a given dataset. Two of the custom Analyzers that can help cast a wider net are <em>stop words</em> and <em>stemming.</em></p>
<ul>
<li>
<p><strong>Stop words:</strong> Stop words are the most frequently occuring words in the English language (for example: "and," "the," "to,” etc.) and add minimal semantic value to a piece of text. It is common practice to remove them in order to decrease the size of the index and increase the relevance of search results.</p>
</li>
<li>
<p><strong>Stemming:</strong> The English language is inflected; words can alter their written form to express different meanings. For example, “sing,” “sings,” “sang,” and “singing” are written with slight differences, but all really mean the same thing (albeit with varying tenses). Stemming algorithms exploit the fact that search intent is <em>usually</em> word-form agnostic, and attempt to reduce inflected words to their root form: consequently improving retrievability.  We'll implement the <a href="https://snowballstem.org/">Snowball</a> stemming algorithm as a token filter in our custom Analyzer.</p>
</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># create new index</span>
<span class="n">index_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"settings"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"analysis"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"analyzer"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"stop_stem_analyzer"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"custom"</span><span class="p">,</span>
                    <span class="s2">"tokenizer"</span><span class="p">:</span> <span class="s2">"standard"</span><span class="p">,</span>
                    <span class="s2">"filter"</span><span class="p">:[</span>
                        <span class="s2">"lowercase"</span><span class="p">,</span>
                        <span class="s2">"stop"</span><span class="p">,</span>
                        <span class="s2">"snowball"</span>
                    <span class="p">]</span>
                    
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">"mappings"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"dynamic"</span><span class="p">:</span> <span class="s2">"strict"</span><span class="p">,</span> 
        <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"document_title"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"text"</span><span class="p">,</span> <span class="s2">"analyzer"</span><span class="p">:</span> <span class="s2">"stop_stem_analyzer"</span><span class="p">},</span>
            <span class="s2">"document_text"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"text"</span><span class="p">,</span> <span class="s2">"analyzer"</span><span class="p">:</span> <span class="s2">"stop_stem_analyzer"</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="n">es</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'squad-stop-stem-index'</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">index_config</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

<span class="c1"># populate the index</span>
<span class="n">populate_index</span><span class="p">(</span><span class="n">es_obj</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">'squad-stop-stem-index'</span><span class="p">,</span> <span class="n">evidence_corpus</span><span class="o">=</span><span class="n">all_wiki_articles</span><span class="p">)</span>

<span class="c1"># evaluate retriever performance</span>
<span class="n">stop_stem_results_df</span><span class="p">,</span> <span class="n">stop_stem_metrics</span> <span class="o">=</span> <span class="n">evaluate_retriever</span><span class="p">(</span><span class="n">es_obj</span><span class="o">=</span><span class="n">es</span><span class="p">,</span> <span class="n">index_name</span><span class="o">=</span><span class="s1">'squad-stop-stem-index'</span><span class="p">,</span>\
                                                             <span class="n">qa_records</span><span class="o">=</span><span class="n">qa_records_answerable</span><span class="p">,</span> <span class="n">n_results</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">stop_stem_metrics</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'Recall': 0.8501115914996388,
 'Mean Average Precision': 0.7800892731997112,
 'Average Query Duration': 0.7684287701215108}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Awesome! We've increased recall and mAP by about 3 points <em>and</em> reduced our average query duration by nearly 4 times, through simple preprocessing steps that just scratch the surface of tailored analysis in Elasticsearch.</p>
<p>There is no "one-size-fits-all" recipe for optimizing search relevance, and every implementation will be different. In addition to custom analysis, there are many other methods for increasing search recall - for example, query expansion, which introduces additional tokens/phrases into a query at search time. We'll save that topic for another post. Instead, let’s take a look at how the Retriever's performance affects a QA system.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="The-Full-IR-QA-System">
<a class="anchor" href="#The-Full-IR-QA-System" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Full IR QA System<a class="anchor-link" href="#The-Full-IR-QA-System"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We used the questions from the train set to evaluate the stand-alone retriever, in order to provide as large a collection as possible. However, BERT has been trained on those questions and would return inflated performance values if we used them for full-system evaluation. So let’s resort to our trusty SQuAD2.0 dev set. 
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 14 16" version="1.1" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 01-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 01-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg>
    <strong>Note: </strong>This section focuses on a discussion. The code to reproduce our results can be found at the end. 
</div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Connecting-the-retriever-to-the-reader">
<a class="anchor" href="#Connecting-the-retriever-to-the-reader" aria-hidden="true"><span class="octicon octicon-link"></span></a>Connecting the retriever to the reader<a class="anchor-link" href="#Connecting-the-retriever-to-the-reader"> </a>
</h2>
<p>In our last post, we evaluated a BERT-like model on the SQuAD2.0 dev set by providing the model with a paragraph that perfectly aligned with the question. This time, the retriever will serve up a collection of relevant documents. We created a reader class that leverages the Hugging Face (HF) question-answering <code>pipeline</code> to do the brunt of the work for us (loading models and tokenizers, converting text to features, chunking, prediction, etc.), but how should it process multiple documents from the retriever? And how should it determine which document contains the best answer?</p>
<p>This turns out to be one of the thornier subtleties in building a full QA system. There are several ways to approach this problem. Here are two that we tried:</p>
<ol>
<li>Pass each document to the reader individually, then aggregate the resulting scores.</li>
<li>Concatenate all documents into one long passage and pass to the reader simultaneously.</li>
</ol>
<p>Both methods have pros and cons. Let's take a look at them.</p>
<p><strong>Pass each document individually</strong></p>
<p>In Option 1, the reader returns answers and scores for each document. A series of heuristics must be developed to determine which answer is the best, and when the null answer should be returned. For this post, we chose a simple but reasonable heuristic: "Only return null if the highest scoring answer in each document is null; otherwise return the highest scoring non-null answer."</p>
<p>Unfortunately, a direct comparison of answer scores between documents is not technically possible. The reason lies in the type of score returned by the HF pipeline: a softmax probability over all the tokens <em>in that document</em>. This means that the only meaningful comparisons are between answers <em>from the same document</em> whose probabilities will sum to 1. Comparing an answer with a score of 0.78 from one document is not guaranteed to be better than an answer with a score of 0.70 from another document!</p>
<p>Finally, this option is slower (in our current implementation) because each article is passed individually, leading to multiple BERT calls.</p>
<p><strong>Pass all documents together as one long context</strong></p>
<p>Option 2 circumvents many of these challenges but leads to other problems. The pros are:</p>
<ol>
<li>all candidate answers are scored on the same probability scale,</li>
<li>handling the null answer is more straightforward (we did that <a href="https://qa.fastforwardlabs.com/no%20answer/null%20threshold/bert/distilbert/exact%20match/f1/robust%20predictions/2020/06/09/Evaluating_BERT_on_SQuAD.html">last time</a>), and</li>
<li>we can take advantage of faster compute, since HF will chunk long documents for us and pass them through BERT in a batch.</li>
</ol>
<p>On the other hand, when concatenating multiple passages, there's a good chance that BERT will see a mixed context: the end of one paragraph grafted onto the beginning of another, for example. This could make it more difficult for the model to correctly identify an answer in a potentially confusing context. Another drawback is that it's more difficult to backstrapolate which of the input documents from which the answer ultimately came.</p>
<p>Our reader class has two methods: <code>predict</code> and <code>predict_combine</code>, corresponding to Option 1 and Option 2, respectively. We tested each of them over 1000 examples from the SQuAD2.0 dev set while increasing the number of retrieved documents.</p>
<p><img src="/images/copied_from_nb/my_icons/qa_eval_combined_vs_individual.png" alt=""></p>
<p>There are two take-aways here. First, we see that the concatenation method (blue bars) outperforms passing documents individually and applying heuristics to the outputs (orange bars). While more sophistical heuristics can be developed, for short documents (paragraphs in this case), we find that the concatenation method is the most straightforward approach.</p>
<p>The second thing to notice is that, as the number of retrieved documents increases, the overall performance decreases for both methods. What's going on? When we evaluated the retriever, we found that increasing the number of retrieved documents <em>increased</em> the likelihood that the correct answer was contained in at least one of them. So why does reader performance degrade?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Evaluating-the-system">
<a class="anchor" href="#Evaluating-the-system" aria-hidden="true"><span class="octicon octicon-link"></span></a>Evaluating the system<a class="anchor-link" href="#Evaluating-the-system"> </a>
</h2>
<p>Standard evaluation on the SQuAD2.0 dev set considers only the best overall answer for each question, but we can create another evaluation metric that mirrors our IR recall metric from earlier. Specifically, we compute the <em>percent of examples in which the correct answer is found in <strong>at least one</strong> of the top k documents provided by the retriever</em>.</p>
<p><img src="/images/copied_from_nb/my_icons/qa_eval_top1_vs_any_topk.png" alt=""></p>
<p>The blue bars are the same as the blue bars in the previous figure, but this time the orange bars represent our new recall-esque metric. What a difference! This demonstrates that when the model is provided with more documents, the correct answer truly is present more often. However, trying to predict which one of those answers is the right one is challenging: this task is not achieved by a simple heuristic, and becomes harder with more documents.</p>
<p>It may seem counterintuitive, but this behavior does make sense. Let’s imagine a simple system that performs ranked document retrieval and random answer selection. Ranked document retrieval, in this case, means that the correct answer is most likely to be found in the top-most ranked document, with some decreasing probability of being contained in the second- or third-ranked document, and so on. As we retrieve more and more documents, the probability <em>increases</em> that the correct answer is contained in the resulting set. However, as the number of documents increases, so too do the number of possible answers from which to choose - one from each document. Random answer selection over an increasing number of answer choices results in a <em>decrease</em> in performance. Obviously, BERT is not random, but it’s also not <em>perfect,</em> so the trait persists.</p>
<p>Does this mean we shouldn't use QA systems like this? Of course not! There are several factors to consider:</p>
<ol>
<li>
<p><strong>Use Case:</strong> If your QA system seeks to provide enhanced search capabilities, then it might not be necessary to predict a single answer with high confidence. It might be sufficient to provide answers from several documents for the user to peruse. On the other hand, if your use case seeks to augment a chatbot, then predicting a high confidence answer might be more important for user experience.</p>
</li>
<li>
<p><strong>Better heuristics:</strong>  While our simple heuristic didn't perform as well as concatenating all the input documents into one long context, there is research into developing heuristics that work. In particular, <a href="https://arxiv.org/abs/1902.01718">one promising approach</a> develops a combined answer score that considers both the retriever's document ranking, and the reader's answer score.</p>
</li>
<li>
<p><strong>Document length:</strong> Our concatenation method works reasonably well compared to other methods, but the documents are short. If the document length becomes considerably longer, this method's performance can degrade significantly.</p>
</li>
</ol>
<p><strong>Impact of a retriever on a QA system</strong></p>
<p>Considering all that we've learned so far, what is the overall impact of the retriever on a full QA system? Using our concatenation method and returning only the best answer for all questions in the SQuAD2.0 dev set, we can compare results with <a href="https://qa.fastforwardlabs.com/no%20answer/null%20threshold/bert/distilbert/exact%20match/f1/robust%20predictions/2020/06/09/Evaluating_BERT_on_SQuAD.html">our previous blog post</a> in which we evaluated only the reader.</p>
<p><img src="/images/copied_from_nb/my_icons/qa_system_vs_reader_only.png" alt=""></p>
<p>As expected, adding a retriever to supply documents to the reader reduces the system's ability to identify the correct answer. This motivates approaches for enhancing the retriever, in order to supply the reader with the best documents possible.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Final-Thoughts">
<a class="anchor" href="#Final-Thoughts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Final Thoughts<a class="anchor-link" href="#Final-Thoughts"> </a>
</h1>
<p>We did it! We built a full QA system with off-the-shelf parts using ElasticSearch and HuggingFace Transformers.</p>
<p>We made a series of design choices in building our full QA system, including the choice to index over Wikipedia paragraphs rather than full articles. This allowed us to more easily replicate SQuAD evaluation methods, but this isn't practical. In the real world, a QA system will need to work with existing indexes, which are typically performed over full documents (not paragraphs). In addition to architectural constraints, indexing over full documents provides the retriever with the best chance of returning a relevant document.</p>
<p>However, passing multiple long documents to a Transformer model is a recipe for boredom -- it will take forever and it likely won't be highly informative. Transformers work best with smaller passages. Thus, extracting a few highly relevant paragraphs from the most relevant document is a better recipe for a practical implementation. This is exactly the approach we'll take next time when we (hopefully) address the biggest question of all:</p>
<blockquote>
<p>How do I apply a QA system to <strong>my</strong> data?</p>
</blockquote>
<p>Stay tuned!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Post-Script:-The-Code">
<a class="anchor" href="#Post-Script:-The-Code" aria-hidden="true"><span class="octicon octicon-link"></span></a>Post Script: The Code<a class="anchor-link" href="#Post-Script:-The-Code"> </a>
</h1>
<p>If you open this notebook in Colab, you'll find several cells below that step through the experiments we ran for the final section.</p>

</div>
</div>
</div>
</div>

<script type="application/vnd.jupyter.widget-state+json">
{"0f9413092ffe496d8f31c374732e870d": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "139cd5c5c43f436495dfddbdfc7d35c3": {"model_module": "@jupyter-widgets/controls", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "15f44b8cf87d459bb6a40b5e6b9db470": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "26b9259fecf4445b8fdcb753ed6d09ef": {"model_module": "@jupyter-widgets/controls", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": "initial"}}, "26ef4a7e1f76465ead7e51c1d9866c6f": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "28a305d13e584615b9ba3cd9a37bdd56": {"model_module": "@jupyter-widgets/controls", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "success", "description": "100%", "description_tooltip": null, "layout": "IPY_MODEL_a8cebe4ccf004d84bdc37ce44d1192e8", "max": 20239, "min": 0, "orientation": "horizontal", "style": "IPY_MODEL_a44c2693aee14b89a4c6512c85142f51", "value": 20239}}, "3c0ffe3eeca741899ddbe1306e60ce39": {"model_module": "@jupyter-widgets/controls", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_26ef4a7e1f76465ead7e51c1d9866c6f", "placeholder": "\u200b", "style": "IPY_MODEL_7a1bbfb20bd84d4b8995584a37dabae1", "value": " 11873/11873 [6:21:18&lt;00:00,  1.93s/it]"}}, "3d3ce5e897b84a218237582372bca2bb": {"model_module": "@jupyter-widgets/controls", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "40b3ea36c5ca407597e8ce6c738c9786": {"model_module": "@jupyter-widgets/controls", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": "initial"}}, "62fb51c849b04bc78c629dd42f811deb": {"model_module": "@jupyter-widgets/controls", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_0f9413092ffe496d8f31c374732e870d", "placeholder": "\u200b", "style": "IPY_MODEL_3d3ce5e897b84a218237582372bca2bb", "value": " 11873/11873 [7:01:01&lt;00:00,  2.13s/it]"}}, "66e0efa9685248629e009c1e255bff6e": {"model_module": "@jupyter-widgets/controls", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_f6c75626f2d54bfbaa7bad761af5b9c2", "IPY_MODEL_62fb51c849b04bc78c629dd42f811deb"], "layout": "IPY_MODEL_f0858954bbfd447eb95a04a3caabf8a4"}}, "705fa1214c044cbcae6f5d109b22802d": {"model_module": "@jupyter-widgets/controls", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "success", "description": "100%", "description_tooltip": null, "layout": "IPY_MODEL_f04b80c35efb44b5bec078f4d7a57f3b", "max": 11873, "min": 0, "orientation": "horizontal", "style": "IPY_MODEL_e30ff795eb1c4016be3967f190764399", "value": 11873}}, "7a1bbfb20bd84d4b8995584a37dabae1": {"model_module": "@jupyter-widgets/controls", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "9061d4497e4443029cbb21b77281cf31": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "95923a713e324d18bc9fc82a466703c4": {"model_module": "@jupyter-widgets/controls", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_ef2c1a3506c549b7878e3ea4a5cc565f", "placeholder": "\u200b", "style": "IPY_MODEL_139cd5c5c43f436495dfddbdfc7d35c3", "value": " 20239/20239 [02:38&lt;00:00, 127.56it/s]"}}, "a299f8fa902348b7807b4d97ebc6027d": {"model_module": "@jupyter-widgets/controls", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_dca5b0a8c1014a66bc8c5ba988878a85", "placeholder": "\u200b", "style": "IPY_MODEL_b04d963baf9a40789305d1372ffe1aab", "value": " 20239/20239 [04:14&lt;00:00, 79.57it/s]"}}, "a44c2693aee14b89a4c6512c85142f51": {"model_module": "@jupyter-widgets/controls", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": "initial"}}, "a493a4c07a2743899571330cf6476b74": {"model_module": "@jupyter-widgets/controls", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_28a305d13e584615b9ba3cd9a37bdd56", "IPY_MODEL_a299f8fa902348b7807b4d97ebc6027d"], "layout": "IPY_MODEL_e94a6f98578743c096c9b045d9dfdf81"}}, "a8cebe4ccf004d84bdc37ce44d1192e8": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "b04d963baf9a40789305d1372ffe1aab": {"model_module": "@jupyter-widgets/controls", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "be3cf3e6c6ba40d087f8dd27dd4f5e64": {"model_module": "@jupyter-widgets/controls", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_705fa1214c044cbcae6f5d109b22802d", "IPY_MODEL_3c0ffe3eeca741899ddbe1306e60ce39"], "layout": "IPY_MODEL_d193d10e1ad94119a849d123c093f3cc"}}, "d193d10e1ad94119a849d123c093f3cc": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "dca5b0a8c1014a66bc8c5ba988878a85": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "e30ff795eb1c4016be3967f190764399": {"model_module": "@jupyter-widgets/controls", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": "initial"}}, "e91c7ba9a6314f0d905d08d0f822cbc1": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "e94a6f98578743c096c9b045d9dfdf81": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "ef2c1a3506c549b7878e3ea4a5cc565f": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "f04b80c35efb44b5bec078f4d7a57f3b": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "f0858954bbfd447eb95a04a3caabf8a4": {"model_module": "@jupyter-widgets/base", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "f4d90214c67749168472a2ba3cb0d72a": {"model_module": "@jupyter-widgets/controls", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "success", "description": "100%", "description_tooltip": null, "layout": "IPY_MODEL_9061d4497e4443029cbb21b77281cf31", "max": 20239, "min": 0, "orientation": "horizontal", "style": "IPY_MODEL_40b3ea36c5ca407597e8ce6c738c9786", "value": 20239}}, "f6c75626f2d54bfbaa7bad761af5b9c2": {"model_module": "@jupyter-widgets/controls", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "success", "description": "100%", "description_tooltip": null, "layout": "IPY_MODEL_e91c7ba9a6314f0d905d08d0f822cbc1", "max": 11873, "min": 0, "orientation": "horizontal", "style": "IPY_MODEL_26b9259fecf4445b8fdcb753ed6d09ef", "value": 11873}}, "f8d18feb30b24de5bbbb869cc9a31ae8": {"model_module": "@jupyter-widgets/controls", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_f4d90214c67749168472a2ba3cb0d72a", "IPY_MODEL_95923a713e324d18bc9fc82a466703c4"], "layout": "IPY_MODEL_15f44b8cf87d459bb6a40b5e6b9db470"}}}
</script>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="fastforwardlabs/ff14_blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/elasticsearch/mean%20average%20precision/recall%20for%20irqa/qa%20system%20design/2020/06/30/Evaluating_the_Retriever_&_End_to_End_System.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>CFF builds a state-of-the-art QA application with the latest NLP techniques</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/fastforwardlabs" title="fastforwardlabs"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/FastForwardLabs" title="FastForwardLabs"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
